plugins {
    id "com.github.hierynomus.license" version "0.14.0"
    id 'net.researchgate.release' version '2.6.0'
    id "org.sonarqube" version "2.6"
    id 'org.unbroken-dome.test-sets' version '1.4.2'
    id 'com.github.psxpaul.execfork' version '0.1.5'
    id 'io.spring.dependency-management' version '1.0.3.RELEASE'
}

archivesBaseName = 'spring-cloud-ribbon-extensions'
group = 'com.github.enadim'
sourceCompatibility = 1.8
targetCompatibility = 1.8

ext {
    jcenterUrl = project.hasProperty('customJcenterUrl') ? project.customJcenterUrl : 'https://jcenter.bintray.com/'
    mavenUrl = project.hasProperty('customMavenUrl') ? project.customMavenUrl : 'https://repo.maven.apache.org/maven2/'
    mavenPluginsUrl = project.hasProperty('customMavenPluginsUrl') ? project.customMavenPluginsUrl : 'https://plugins.gradle.org/m2/'

    jvm = org.gradle.internal.jvm.Jvm.current()
    javaDescription = '' + jvm
    javaVersion = '' + JavaVersion.current()

    projectUrl = 'https://github.com/enadim/' + archivesBaseName
    projectDescription = 'Netflix ribbon extensions.'
    projectScmUrl = 'scm:git:' + projectUrl + '.git'

    licenseName = 'The Apache License, Version 2.0'
    licenseUrl = 'http://www.apache.org/licenses/LICENSE-2.0.txt'

    authorId = 'enadim'
    authorName = 'Nadim Benabdenbi'
    authorEmail = 'nadim.benabdenbi@gmail.com'

    gitCommitId = 'git rev-parse HEAD'.execute().text.trim()
    gitBranchName = 'git name-rev --name-only HEAD'.execute().text.trim()
    isReleaseVersion = !version.endsWith("SNAPSHOT")
}

apply plugin: 'java'
apply plugin: 'maven'
apply plugin: 'org.sonarqube'
apply plugin: 'io.spring.dependency-management'
apply plugin: 'project-report'
apply plugin: 'build-dashboard'
apply plugin: 'com.github.psxpaul.execfork'
apply from: 'gradle/ide.gradle'
apply from: 'gradle/license.gradle'
apply from: 'gradle/coding.gradle'
apply from: 'gradle/tests.gradle'
apply from: 'gradle/jacoco.gradle'
apply from: 'gradle/artifacts.gradle'
apply from: 'gradle/signing.gradle'
apply from: 'gradle/release.gradle'

task wrapper(type: Wrapper) {
    gradleVersion = '4.3'
}

repositories {
    jcenter {
        url jcenterUrl
    }
    mavenLocal()
    maven {
        url mavenUrl
    }
}

dependencyManagement {
    imports {
        mavenBom 'org.springframework.cloud:spring-cloud-dependencies:Dalston.SR3'
        mavenBom 'org.springframework.boot:spring-boot:1.5.6.RELEASE'
    }
}

dependencies {
    compileOnly 'org.projectlombok:lombok:1.16.16'
    compileOnly 'com.google.code.findbugs:annotations:3.0.1'

    compile("org.springframework.boot:spring-boot-starter-activemq") { ext.optional = true }
    compile("org.apache.activemq:activemq-broker")                   { ext.optional = true }
    compile("com.fasterxml.jackson.core:jackson-databind")           { ext.optional = true }
    compile('org.springframework.cloud:spring-cloud-starter-ribbon') { ext.optional = true }
    compile('org.springframework.cloud:spring-cloud-starter-feign')  { ext.optional = true}
    compile('org.springframework.cloud:spring-cloud-starter-eureka') { ext.optional = true}
    compile('org.springframework.cloud:spring-cloud-starter-eureka') { ext.optional = true}
    compile('org.springframework.cloud:spring-cloud-starter-eureka-server') {
        exclude group: 'javax.servlet', module: 'servlet-api'
        ext.optional = true
    }

    testCompileOnly 'org.projectlombok:lombok:1.16.16'
    testCompile 'org.springframework.cloud:spring-cloud-starter-zuul'
    testCompile 'org.springframework.boot:spring-boot-starter-web'
    testCompile 'org.springframework.boot:spring-boot-test'
    testCompile 'org.springframework.boot:spring-boot-starter-test'
    testCompile 'org.mockito:mockito-core:2.11.0'
    testCompile 'net.bytebuddy:byte-buddy:1.7.4'
    testCompile 'io.rest-assured:rest-assured:3.0.3'
}

compileJava {
    options.fork = true
}

task eureka(type: com.github.psxpaul.task.JavaExecFork) {
    main = 'com.github.enadim.spring.cloud.ribbon.examples.eureka.EurekaApplication'
    classpath = sourceSets.examples.runtimeClasspath
    workingDir = "$buildDir"
    standardOutput = "$buildDir/eureka.log"
    errorOutput = "$buildDir/eureka-error.log"
    waitForPort = 8000
    timeout = 30
}

task application11(type: com.github.psxpaul.task.JavaExecFork) {
    main = 'com.github.enadim.spring.cloud.ribbon.examples.application1.Application1'
    classpath = sourceSets.examples.runtimeClasspath
    args = ['--spring.config.name=application11']
    workingDir = "$buildDir"
    standardOutput = "$buildDir/application11.log"
    errorOutput = "$buildDir/application11-error.log"
    waitForPort = 8011
    timeout = 30
}
application11.dependsOn eureka

task application12(type: com.github.psxpaul.task.JavaExecFork) {
    main = 'com.github.enadim.spring.cloud.ribbon.examples.application1.Application1'
    classpath = sourceSets.examples.runtimeClasspath
    args = ['--spring.config.name=application12']
    workingDir = "$buildDir"
    standardOutput = "$buildDir/application12.log"
    errorOutput = "$buildDir/application12-error.log"
    waitForPort = 8012
    timeout = 30
}
application12.dependsOn application11

task application21(type: com.github.psxpaul.task.JavaExecFork) {
    main = 'com.github.enadim.spring.cloud.ribbon.examples.application2.Application2'
    classpath = sourceSets.examples.runtimeClasspath
    args = ['--spring.config.name=application21']
    workingDir = "$buildDir"
    standardOutput = "$buildDir/application21.log"
    errorOutput = "$buildDir/application21-error.log"
    waitForPort = 8021
    timeout = 30
}

application21.dependsOn application12

task application22(type: com.github.psxpaul.task.JavaExecFork) {
    main = 'com.github.enadim.spring.cloud.ribbon.examples.application2.Application2'
    classpath = sourceSets.examples.runtimeClasspath
    args = ['--spring.config.name=application22']
    workingDir = "$buildDir"
    standardOutput = "$buildDir/application22.log"
    errorOutput = "$buildDir/application22-error.log"
    waitForPort = 8022
    timeout = 30
}
application22.dependsOn application21

task zuul(type: com.github.psxpaul.task.JavaExecFork) {
    main = 'com.github.enadim.spring.cloud.ribbon.examples.zuul.ZuulApplication'
    classpath = sourceSets.examples.runtimeClasspath
    workingDir = "$buildDir"
    standardOutput = "$buildDir/zuul.log"
    errorOutput = "$buildDir/zuul-error.log"
    waitForPort = 8001
    timeout = 30
}
zuul.dependsOn application22

if (project.hasProperty('it')) {
    examples.dependsOn test
    zuul.dependsOn examples
    integrationTest.dependsOn zuul
    check.dependsOn integrationTest
    project.tasks["sonarqube"].dependsOn integrationTest
} else {
    project.tasks["sonarqube"].dependsOn test
}